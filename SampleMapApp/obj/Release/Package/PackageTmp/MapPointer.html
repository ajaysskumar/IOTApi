<!DOCTYPE html>
<html>
<head>
    <title>Geolocation</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
         /* Always set the map height explicitly to define the size of the div
        * element that contains the map. */
         #map {
             height: 100%;
         }
         /* Optional: Makes the sample page fill the window. */
         html, body {
             height: 100%;
             margin: 0;
             padding: 0;
         }
    </style>
</head>
<body>
    <div id="map"></div>
    <script src="mqttws31.js" type="text/javascript"></script>
    <script>
        var map;
        var infoWindow;

      // Note: This example requires that you consent to location sharing when
      // prompted by your browser. If you see the error "The Geolocation service
      // failed.", it means you probably did not give permission for the browser to
      // locate you.

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: 28.491740, lng: 77.085998 },
          zoom: 6
        });
        infoWindow = new google.maps.InfoWindow({map: map});

        //// Try HTML5 geolocation.
        //if (navigator.geolocation) {
        //  navigator.geolocation.getCurrentPosition(function(position) {
        //    var pos = {
        //      lat: position.coords.latitude,
        //      lng: position.coords.longitude
        //    };

        //    infoWindow.setPosition(pos);
        //    infoWindow.setContent('Location found.');
        //    map.setCenter(pos);
        //  }, function() {
        //    handleLocationError(true, infoWindow, map.getCenter());
        //  });
        //} else {
        //  // Browser doesn't support Geolocation
        //  handleLocationError(false, infoWindow, map.getCenter());
        //}
      }

      function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(browserHasGeolocation ?
                              'Error: The Geolocation service failed.' :
                              'Error: Your browser doesn\'t support geolocation.');
      }



      // Create a client instance
      client = new Paho.MQTT.Client("m13.cloudmqtt.com", 39334, "mapdevice");
      //Example client = new Paho.MQTT.Client("m11.cloudmqtt.com", 32903, "web_" + parseInt(Math.random() * 100, 10));

      // set callback handlers
      client.onConnectionLost = onConnectionLost;
      client.onMessageArrived = onMessageArrived;
      var options = {
          useSSL: true,
          userName: "cbaeasea",
          password: "KiYFQP0Q1gbe",
          onSuccess: onConnect,
          onFailure: doFail
      }

      // connect the client
      client.connect(options);

      // called when the client connects
      function onConnect() {
          // Once a connection has been made, make a subscription and send a message.
          console.log("onConnect");
          client.subscribe("locationData");
          console.log("Subscribed to locationData");
          message = new Paho.MQTT.Message("Hello CloudMQTT");
          message.destinationName = "/cloudmqtt";
          client.send(message);
      }

      function doFail(e) {
          console.log(e);
      }

      // called when the client loses its connection
      function onConnectionLost(responseObject) {
          if (responseObject.errorCode !== 0) {
              console.log("onConnectionLost:" + responseObject.errorMessage);
          }
      }

      var marker;

      // called when a message arrives
      function onMessageArrived(message) {
          console.log("onMessageArrived:" + message.payloadString);
          var loc = JSON.parse(message.payloadString);
          var pos = {
              lat: loc.Latitude,
              lng: loc.Longitude
          };
          // Try HTML5 geolocation.
          if (navigator.geolocation) {
              //navigator.geolocation.getCurrentPosition(function (position) {
                  

                  
              //}, function () {
              //    handleLocationError(true, infoWindow, map.getCenter());
              //});
              //infoWindow.setPosition(pos);
              //infoWindow.setContent('Latitude : '+ loc.Latitude+'\nLongitude : '+loc.Longitude );
              //map.setCenter(pos);
              marker = new google.maps.Marker({
                  position: new google.maps.LatLng(loc.Latitude, loc.Longitude),
                  map: map
              });
          } else {
              // Browser doesn't support Geolocation
              handleLocationError(false, infoWindow, map.getCenter());
          }
      }
    </script>


    <script type="text/javascript">

  
    </script>
    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCvnYUAPY9FEDJf1szBTGUw8q6LtcvY6m8&callback=initMap">
    </script>
</body>
</html>